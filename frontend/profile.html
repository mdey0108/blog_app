<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile | Blog App</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap">
    <style>
        /* Button Loading State */
        .btn-loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }

        .btn-loading::after {
            content: "";
            position: absolute;
            left: 50%;
            top: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }


        /* Profile Action Buttons */
        .profile-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .btn-icon {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .btn-outline-primary {
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline-primary:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-outline-secondary {
            background: transparent;
            border: 1px solid #cbd5e1;
            color: #475569;
        }

        .btn-outline-secondary:hover {
            border-color: #94a3b8;
            background: #f8fafc;
            color: #1e293b;
        }
    </style>

<body>
    <nav class="navbar">
        <div class="container nav-content">
            <a href="index.html" class="brand">BlogApp</a>
            <div id="nav-links" class="nav-links"></div>
        </div>
    </nav>

    <div class="container" style="max-width: 800px; padding-top: 2rem;">
        <!-- Toast Container -->
        <div id="toast" class="toast"></div>

        <!-- Profile Section View -->
        <div
            style="background: white; padding: 2rem; border-radius: 1rem; border: 1px solid var(--border-color); margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h2 style="margin-bottom: 0.5rem;" id="view-name">Loading...</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 0.25rem;" id="view-username">@...</p>
                    <p style="color: var(--text-secondary);" id="view-email">...</p>
                </div>
                <div class="profile-actions">
                    <button onclick="openModal('edit-profile-modal')" class="btn-icon btn-outline-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                        Edit Profile
                    </button>
                    <button onclick="openModal('change-password-modal')" class="btn-icon btn-outline-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                        Change Password
                    </button>
                </div>
            </div>
        </div>

        <!-- Edit Profile Modal -->
        <div id="edit-profile-modal" class="modal-overlay">
            <div class="modal-content">
                <button class="modal-close" onclick="closeModal('edit-profile-modal')">&times;</button>
                <h2 style="margin-bottom: 1.5rem;">Edit Profile</h2>
                <form id="profile-form">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" id="name" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" id="username" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="email" class="form-input" required>
                    </div>
                    <button type="submit" class="nav-btn btn-primary" style="width: 100%;">Update Profile</button>
                </form>
            </div>
        </div>

        <!-- Change Password Modal -->
        <div id="change-password-modal" class="modal-overlay">
            <div class="modal-content">
                <button class="modal-close" onclick="closeModal('change-password-modal')">&times;</button>
                <h2 style="margin-bottom: 1.5rem;">Change Password</h2>
                <form id="password-form">
                    <div class="form-group">
                        <label class="form-label">Old Password</label>
                        <input type="password" id="oldPassword" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <input type="password" id="newPassword" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" id="confirmNewPassword" class="form-input" required>
                    </div>
                    <button type="submit" class="nav-btn btn-primary" style="width: 100%;">Update Password</button>
                </form>
            </div>
        </div>

        <!-- My Posts Section -->
        <h2 style="margin-bottom: 1.5rem;">My Posts</h2>
        <div id="my-posts-container">
            <div style="text-align: center; color: var(--text-secondary);">Loading posts...</div>
        </div>

    </div>

    <footer id="main-footer"></footer>
    <script src="app.js"></script>
    <script>
        checkAuthProtection();


        // Loading Helper
        function setLoading(btn, isLoading, text = 'Update') {
            if (isLoading) {
                btn.classList.add('btn-loading');
                btn.textContent = text; // Keeps width somewhat stable if text matches
            } else {
                btn.classList.remove('btn-loading');
                btn.textContent = text;
            }
        }

        // Modal Helpers
        function openModal(id) {
            document.getElementById(id).classList.add('open');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('open');
        }

        // Close modal if clicking outside
        window.onclick = function (event) {
            if (event.target.classList.contains('modal-overlay')) {
                event.target.classList.remove('open');
            }
        }

        async function loadProfile() {
            const profile = await request('/users/me');
            if (profile) {
                // Populate View
                document.getElementById('view-name').innerText = profile.name;
                document.getElementById('view-username').innerText = '@' + profile.username;
                document.getElementById('view-email').innerText = profile.email;

                // Populate Edit Form
                document.getElementById('name').value = profile.name;
                document.getElementById('username').value = profile.username;
                document.getElementById('email').value = profile.email;

                await loadMyPosts(profile.id);
            } else {
                throw new Error("Could not load user profile data.");
            }
        }

        async function updateProfile(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            setLoading(btn, true, 'Updating...');

            const name = document.getElementById('name').value;
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;

            // Optional: Basic validation
            if (!name || !username || !email) {
                showToast("All fields are required", "error");
                setLoading(btn, false, 'Update Profile');
                return;
            }

            const res = await request('/users/me', 'PUT', { name, username, email });

            setLoading(btn, false, 'Update Profile');

            if (res) {
                showToast('Profile updated successfully!');
                closeModal('edit-profile-modal');

                // Update View immediately
                document.getElementById('view-name').innerText = name;
                document.getElementById('view-username').innerText = '@' + username;
                document.getElementById('view-email').innerText = email;
            }
        }

        async function updatePassword(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');

            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            if (newPassword !== confirmNewPassword) {
                showToast("New passwords do not match!", "error");
                return;
            }

            setLoading(btn, true, 'Updating...');

            const res = await request('/users/me/password', 'PUT', { oldPassword, newPassword });

            setLoading(btn, false, 'Update Password');

            if (res) {
                showToast('Password updated successfully!');
                document.getElementById('password-form').reset();
                closeModal('change-password-modal');
            }
        }

        document.getElementById('profile-form').addEventListener('submit', updateProfile);
        document.getElementById('password-form').addEventListener('submit', updatePassword);

        // Initialize with error handling
        // Initialize
        (async function init() {
            try {
                // If ID query param exists, we are viewing someone else (or explicit user)
                // If NO ID param, we are viewing ME (require auth)

                updateNavbar();
                updateFooter();

                const urlParams = new URLSearchParams(window.location.search);
                const queryId = urlParams.get('id');
                const myId = getCurrentUserId();

                // Determine Mode
                let targetId = queryId;
                let isMe = false;

                if (!targetId) {
                    // No ID param -> My Profile mode (Must be logged in)
                    checkAuthProtection();
                    targetId = myId;
                    isMe = true;
                } else {
                    // ID param exists. Check if it's me
                    if (myId && String(myId) === String(targetId)) {
                        isMe = true;
                    }
                }

                // Load Logic
                if (isMe) {
                    // Load My Profile (using /users/me for better security/data)
                    // Or just use targetId if we want to standardize. 
                    // Let's stick to /users/me for my profile to ensure we get email etc.
                    await loadMyProfile();
                } else {
                    // Load Public Profile
                    // Hide Edit Buttons
                    document.querySelector('.profile-actions').style.display = 'none';
                    await loadPublicProfile(targetId);
                }

            } catch (error) {
                console.error("Profile Load Error:", error);
                document.body.innerHTML = `<div style="text-align:center; padding: 2rem; color: red;">Failed to load profile: ${error.message}</div>`;
            }
        })();

        async function loadMyProfile() {
            const profile = await request('/users/me');
            if (profile) {
                renderProfileData(profile);
                // Show Edit Buttons (Already visible by default)
                await loadMyPosts(profile.id);
            } else {
                throw new Error("Could not load user profile data.");
            }
        }

        async function loadPublicProfile(id) {
            const profile = await request(`/users/${id}/profile`); // Uses public endpoint
            if (profile) {
                renderProfileData(profile);
                // Hide Private Info in UI if needed (email might be null from backend)
                if (!profile.email) {
                    document.getElementById('view-email').style.display = 'none';
                }
                document.getElementById('view-name').textContent = profile.name; // Keep consistency

                await loadMyPosts(id); // Reusing logic but need to handle "Delete" button visibility
            } else {
                throw new Error("User not found.");
            }
        }

        function renderProfileData(profile) {
            document.getElementById('view-name').innerText = profile.name;
            document.getElementById('view-username').innerText = '@' + profile.username;
            document.getElementById('view-email').innerText = profile.email || '';

            // Populate Edit Form (only matters if isMe, but harmless otherwise)
            document.getElementById('name').value = profile.name;
            document.getElementById('username').value = profile.username;
            document.getElementById('email').value = profile.email || '';
        }

        async function loadMyPosts(userId) {
            const posts = await request(`/posts/user/${userId}`);
            const container = document.getElementById('my-posts-container');

            if (!posts || posts.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">You haven\'t created any posts yet.</p>';
                return;
            }

            // Determine if we can delete (Me only)
            const myId = getCurrentUserId();
            // userId here is the target profile's user ID.
            const isOwner = myId && String(myId) === String(userId);

            // Render Posts
            container.innerHTML = posts.map(post => {
                // Media Preview Logic
                let mediaPreview = '';
                if (post.media && post.media.length > 0) {
                    const m = post.media[0];
                    const url = 'http://localhost:8080' + (m.fileUrl || m.url);
                    if (m.contentType && m.contentType.startsWith('image')) {
                        mediaPreview = `<img src="${url}" style="width: 100%; height: 300px; object-fit: cover; border-radius: 0.5rem; margin-top: 1rem;">`;
                    } else if (m.contentType && m.contentType.startsWith('video')) {
                        mediaPreview = `<video src="${url}" controls style="width: 100%; max-height: 300px; border-radius: 0.5rem; margin-top: 1rem;"></video>`;
                    }
                }

                // Initial for Avatar
                const initial = (post.title || '?').charAt(0).toUpperCase();

                // Delete Button HTML (Empty if not owner)
                const deleteBtn = isOwner ? `
                        <button onclick="deleteMyPost(${post.id})" title="Delete Post" style="margin-left: auto; color: #ef4444; background: #fee2e2; border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                ` : '';

                // If not owner, the header layout needs to push info to right or keep spacing?
                // Flex gap handles it, but if no button, margin-left: auto on something else?
                // Actually, if deleteBtn is empty, post-info takes space. 
                // We might want to ensure layout consistency.

                return `
                <div class="post-card">
                    <div class="post-header">
                        <div class="post-avatar">${initial}</div>
                        <div class="post-info" style="${!isOwner ? 'flex-grow: 1;' : ''}">
                            <h3 style="display: flex; align-items: center; gap: 0.5rem;">
                                ${post.authorName || 'User'}
                                ${post.authorIsAdmin ? '<span title="Admin" style="color: var(--primary-color); display: flex;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg></span>' : ''}
                            </h3>
                            <span>${new Date(post.createdDate).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' })} • ${post.categoryId ? 'Category ' + post.categoryId : 'General'}</span>
                        </div>
                        ${deleteBtn}
                    </div>

                    <a href="post.html?id=${post.id}" style="text-decoration: none; color: inherit;">
                        <h2 class="post-title">${post.title}</h2>
                        <p class="post-desc">${post.description}</p>
                        ${mediaPreview}
                    </a>

                    <div class="post-actions">
                        <button class="action-btn" onclick="location.href='post.html?id=${post.id}'" style="color: ${post.liked ? '#ef4444' : 'inherit'}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="${post.liked ? '#ef4444' : 'none'}" stroke="${post.liked ? '#ef4444' : 'currentColor'}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                            ${post.likeCount} Likes
                        </button>
                        <button class="action-btn" onclick="location.href='post.html?id=${post.id}'">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                            Comment
                        </button>
                        <button class="action-btn" style="margin-left: auto;" onclick="location.href='post.html?id=${post.id}'">
                            Read more →
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }

        async function deleteMyPost(id) {
            const confirmed = await showConfirm('Delete this post?');
            if (!confirmed) return;

            const res = await request(`/posts/${id}`, 'DELETE');
            if (res) {
                const userId = getCurrentUserId();
                loadMyPosts(userId);
                showToast('Post deleted', 'success');
            }
        }

    </script>
</body>

</html>