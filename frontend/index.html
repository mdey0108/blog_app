<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feed | Blog App</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap">
</head>

<body>
    <nav class="navbar">
        <div class="container nav-content">
            <a href="index.html" class="brand">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="feather feather-feather">
                    <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path>
                    <line x1="16" y1="8" x2="2" y2="22"></line>
                    <line x1="17.5" y1="15" x2="9" y2="15"></line>
                </svg>
                BlogApp
            </a>
            <div id="nav-links" class="nav-links">
                <!-- Links will be injected by app.js -->
            </div>
        </div>
    </nav>

    <div class="container feed-layout">

        <!-- Create Post Widget (only if logged in) -->
        <div id="create-post-widget" class="create-post-widget" style="display: none;"
            onclick="window.location.href='create-post.html'">
            <div class="post-avatar"
                style="width: 40px; height: 40px; background: #e0e7ff; color: var(--primary-color);">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
            </div>
            <div class="create-post-input">What's on your mind?</div>
        </div>

        <div id="posts-container">
            <!-- Posts will be injected here -->
            <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                <svg class="spinner" width="24" height="24" viewBox="0 0 50 50">...</svg> Loading feed...
            </div>
        </div>

        <div class="pagination" id="pagination"
            style="display: flex; justify-content: center; gap: 1rem; margin: 2rem 0;">
            <button id="prev-btn" class="nav-btn btn-outline" disabled>Previous</button>
            <button id="next-btn" class="nav-btn btn-outline" disabled>Next</button>
        </div>
    </div>


    <footer id="main-footer"></footer>
    <script src="app.js"></script>
    <script>
        let currentPage = 0;
        const pageSize = 10;

        // Show create widget if logged in
        if (isAuthenticated()) {
            document.getElementById('create-post-widget').style.display = 'flex';
        }

        async function loadPosts(page) {
            const postsContainer = document.getElementById('posts-container');

            // Sort by CreatedDate Descending by default
            const data = await request(`/posts?pageNo=${page}&pageSize=${pageSize}&sortBy=createdDate&sortDir=desc`);

            if (!data) {
                postsContainer.innerHTML = '<div style="text-align: center;">Failed to load posts.</div>';
                return;
            }

            if (data.content.length === 0) {
                // ... empty state ...
                postsContainer.innerHTML = `
                    <div style="text-align: center; padding: 3rem; background: white; border-radius: 1rem; border: 1px solid var(--border-color);">
                        <h3>No posts yet</h3>
                        <p style="color: var(--text-secondary);">Be the first to create one!</p>
                    </div>`;
                return;
            }

            postsContainer.innerHTML = data.content.map(post => {
                // Mock Avatar Initials based on category or random
                const initial = post.title.charAt(0).toUpperCase();

                // Media Preview (First item)
                let mediaPreview = '';
                if (post.media && post.media.length > 0) {
                    const m = post.media[0];
                    const url = 'http://localhost:8080' + m.fileUrl;
                    if (m.contentType.startsWith('image')) {
                        mediaPreview = `<img src="${url}" style="width: 100%; height: 300px; object-fit: cover; border-radius: 0.5rem; margin-top: 1rem;">`;
                    } else if (m.contentType.startsWith('video')) {
                        mediaPreview = `<video src="${url}" controls style="width: 100%; max-height: 300px; border-radius: 0.5rem; margin-top: 1rem;"></video>`;
                    }
                }

                return `
                <div class="post-card">
                    <div class="post-header">
                        <div class="post-avatar">${initial}</div>
                        <div class="post-info">
                            <h3 style="display: flex; align-items: center; gap: 0.5rem;">
                                ${post.authorIsActive ? `<a href="profile.html?id=${post.userId}" style="text-decoration: none; color: inherit; hover: underline;">${post.authorName || 'Anonymous Author'}</a>` : `<span style="color: var(--text-secondary);">${post.authorName || 'Anonymous Author'} (Deactivated)</span>`}
                                ${post.authorIsAdmin ? '<span title="Admin" style="color: var(--primary-color); display: flex;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg></span>' : ''}
                            </h3> 
                            <span>${new Date(post.createdDate).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' })} • ${post.categoryId ? 'Category ' + post.categoryId : 'General'}</span>
                        </div>
                    </div>
                    
                    <a href="post.html?id=${post.id}" style="text-decoration: none; color: inherit;">
                        <h2 class="post-title">${post.title}</h2>
                        <p class="post-desc">${post.description}</p>
                        ${mediaPreview}
                    </a>
                    
                    <div class="post-actions">
                        <button class="action-btn" onclick="togglePostLike(${post.id})" style="color: ${post.liked ? '#ef4444' : 'inherit'}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="${post.liked ? '#ef4444' : 'none'}" stroke="${post.liked ? '#ef4444' : 'currentColor'}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                            ${post.likeCount} Likes
                        </button>
                        <button class="action-btn" onclick="location.href='post.html?id=${post.id}'">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                            Comment
                        </button>
                        <button class="action-btn" style="margin-left: auto;" onclick="location.href='post.html?id=${post.id}'">
                            Read more →
                        </button>
                    </div>
                </div>
            `}).join('');

            // Update Pagination Buttons
            document.getElementById('prev-btn').disabled = data.pageNo === 0;
            document.getElementById('next-btn').disabled = data.last;
            currentPage = data.pageNo;
        }

        async function togglePostLike(id) {
            if (!isAuthenticated()) {
                showToast('Please login to like posts', 'error');
                return;
            }
            // Optimistic UI update could be done here, but reloading is safer for sync
            const res = await request(`/posts/${id}/like`, 'POST');
            if (res !== null) {
                // Reload current page to see updated count and state
                loadPosts(currentPage);
            }
        }


        // Event Listeners
        document.getElementById('prev-btn').addEventListener('click', () => {
            if (currentPage > 0) loadPosts(currentPage - 1);
        });

        document.getElementById('next-btn').addEventListener('click', () => {
            loadPosts(currentPage + 1);
        });

        // Initialize
        updateNavbar();
        updateFooter();

        // Check for Flash Message
        const flashMsg = localStorage.getItem('flashMessage');
        if (flashMsg) {
            const flashType = localStorage.getItem('flashType') || 'info';
            showToast(flashMsg, flashType);
            localStorage.removeItem('flashMessage');
            localStorage.removeItem('flashType');
        }

        loadPosts(currentPage);
    </script>
</body>

</html>