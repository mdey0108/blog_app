<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Blog App</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap">
    <style>
        .table-container {
            background: white;
            border-radius: 1rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            overflow: hidden;
            margin-top: 2rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            color: var(--text-secondary);
        }

        tr:last-child td {
            border-bottom: none;
        }

        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-admin {
            background: #e0e7ff;
            color: var(--primary-color);
        }

        .badge-user {
            background: #f1f5f9;
            color: var(--text-secondary);
        }

        .action-btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 0.25rem;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background: white;
        }

        .btn-delete {
            color: #ef4444;
            border-color: #fecaca;
        }

        .btn-delete:hover {
            background: #fef2f2;
        }


        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-family: inherit;
        }

        .nav-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        /* Dashboard Banner */
        .dashboard-banner {
            background: linear-gradient(135deg, var(--primary-color) 0%, #4338ca 100%);
            color: white;
            padding: 2.5rem 2rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .dashboard-banner h1 {
            margin: 0 0 0.5rem 0;
            font-size: 2rem;
            font-weight: 700;
        }

        .dashboard-banner p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="container nav-content">
            <a href="index.html" class="brand">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path>
                    <line x1="16" y1="8" x2="2" y2="22"></line>
                    <line x1="17.5" y1="15" x2="9" y2="15"></line>
                </svg>
                BlogApp <span style="font-size: 0.8em; opacity: 0.7; margin-left: 0.5rem;">Admin</span>
            </a>
            <div id="nav-links" class="nav-links">
                <!-- Links will be injected by app.js -->
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-banner">
            <h1>Admin Dashboard</h1>
            <p>Manage users, promote admins, and moderate content.</p>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Roles</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="users-table-body">
                    <tr>
                        <td colspan="5" style="text-align: center;">Loading users...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Reset Password Modal -->
        <div id="reset-modal" class="modal-overlay">
            <div class="modal-content">
                <button class="modal-close" onclick="closeModal('reset-modal')">&times;</button>
                <h2 style="margin-bottom: 1.5rem;">Reset Password</h2>
                <form id="reset-form" onsubmit="handleResetSubmit(event)">
                    <input type="hidden" id="reset-user-id">
                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <input type="password" id="new-password" class="form-input" placeholder="Enter new password"
                            required>
                    </div>
                    <button type="submit" class="nav-btn btn-primary" style="width: 100%;">Reset Password</button>
                </form>
            </div>
        </div>
    </div>

    <footer id="main-footer"></footer>
    <script src="app.js"></script>
    <script>
        checkAdminProtection();
        updateNavbar();

        async function loadUsers() {
            const users = await request('/users');
            const tbody = document.getElementById('users-table-body');

            if (!users) return;

            tbody.innerHTML = users.map(user => {
                // Robust check for active status (handles 'active' or 'isActive')
                const userIsActive = (user.active !== undefined) ? user.active : user.isActive;

                // Check if user has ROLE_ADMIN
                const isAdmin = user.roles.some(r => r.name === 'ROLE_ADMIN');
                const roleBadge = isAdmin
                    ? '<span class="badge badge-admin">ADMIN</span>'
                    : '<span class="badge badge-user">USER</span>';

                // Promote Button (only if not admin)
                const promoteBtn = !isAdmin
                    ? `<button class="action-btn-sm" onclick="promoteUser(${user.id})">Make Admin</button>`
                    : '';

                // Revoke Button (only if IS admin and NOT self)
                const currentUserId = getCurrentUserId();
                const isSelf = user.id === currentUserId;
                const revokeBtn = isAdmin && !isSelf
                    ? `<button class="action-btn-sm" onclick="revokeAdmin(${user.id})" style="color: #ea580c; border-color: #fdba74;">Revoke</button>`
                    : '';

                // Delete Button (don't allow deleting self ideally, but simplistic here)
                const deleteBtn = `<button class="action-btn-sm btn-delete" onclick="deleteUser(${user.id})">Delete</button>`;

                return `
                    <tr>
                        <td>#${user.id}</td>
                        <td>
                            <div style="font-weight: 500;">${user.name}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">@${user.username}</div>
                        </td>
                        <td>${user.email}</td>
                        <td>
                            ${roleBadge}
                            ${!userIsActive ? '<span class="badge" style="background: #fee2e2; color: #ef4444; margin-left: 0.5rem;">INACTIVE</span>' : ''}
                        </td>
                        <td style="display: flex; gap: 0.5rem;">
                            ${promoteBtn}
                            ${revokeBtn}
                            ${userIsActive ? `<button class="action-btn-sm btn-delete" onclick="deleteUser(${user.id})">Deactivate</button>` : ''}
                            ${!userIsActive ? `<button class="action-btn-sm" style="color: green; border-color: green;" onclick="activateUser(${user.id})">Activate</button>` : ''}
                            <button class="action-btn-sm" style="color: #6366f1; border-color: #818cf8;" onclick="resetPassword(${user.id})">Reset Pwd</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function promoteUser(id) {
            const confirmed = await showConfirm('Are you sure you want to promote this user to Admin?', 'Promote User');
            if (!confirmed) return;

            const res = await request(`/users/${id}/role`, 'PUT');
            if (res !== null) {
                showToast('User promoted to Admin', 'success');
                loadUsers();
            }
        }

        async function revokeAdmin(id) {
            const confirmed = await showConfirm('Are you sure you want to revoke Admin privileges?', 'Revoke Admin');
            if (!confirmed) return;

            const res = await request(`/users/${id}/role/revoke`, 'PUT');
            if (res !== null) {
                showToast('Admin privileges revoked', 'success');
                loadUsers();
            }
        }

        async function deleteUser(id) {
            const confirmed = await showConfirm('Are you sure you want to DEACTIVATE this user?', 'Deactivate User');
            if (!confirmed) return;

            const res = await request(`/users/${id}`, 'DELETE');
            if (res) {
                showToast('User deactivated', 'success');
                loadUsers(); // Better than reload because it keeps UI state
            }
        }

        async function activateUser(id) {
            const confirmed = await showConfirm('Activate this user?', 'Activate User');
            if (!confirmed) return;

            const res = await request(`/users/${id}/activate`, 'PUT');
            if (res !== null) {
                showToast('User activated', 'success');
                loadUsers();
            }
        }

        // Modal Helpers
        function openModal(id) {
            document.getElementById(id).classList.add('open');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('open');
        }

        window.onclick = function (event) {
            if (event.target.classList.contains('modal-overlay')) {
                event.target.classList.remove('open');
            }
        }

        function resetPassword(userId) {
            document.getElementById('reset-user-id').value = userId;
            document.getElementById('new-password').value = '';
            openModal('reset-modal');
        }

        async function handleResetSubmit(e) {
            e.preventDefault();
            const userId = document.getElementById('reset-user-id').value;
            const newPassword = document.getElementById('new-password').value;

            const res = await request(`/users/${userId}/password`, 'PUT', { newPassword });

            if (res) {
                showToast('Password reset successfully!', 'success');
                closeModal('reset-modal');
            }
        }

        loadUsers();
    </script>
</body>

</html>